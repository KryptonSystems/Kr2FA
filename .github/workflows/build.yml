name: Build Velocity Plugin
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

# Required so the job can push commits
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Bump plugin version and commit
        # If you want to push from forks/PRs, create a repository secret REPO_WRITE_TOKEN with a PAT that has repo scope and set it in repo settings.
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          REPO_TOKEN: ${{ secrets.REPO_WRITE_TOKEN || '' }}
        run: |
          set -e
          # Generate a new version that changes every run. Adjust format as you like.
          NEW_VERSION="1.0.${{ github.run_number }}"
          echo "Setting new version: $NEW_VERSION"

          # Use Maven Versions Plugin to set version (no backup POMs)
          mvn -q versions:set -DnewVersion="$NEW_VERSION" -DgenerateBackupPoms=false

          # Stage changes and commit if any
          git add -A
          if git diff --cached --quiet; then
            echo "No version changes to commit"
          else
            git -c user.name="$GIT_AUTHOR_NAME" -c user.email="$GIT_AUTHOR_EMAIL" commit -m "ci: bump plugin version to $NEW_VERSION [skip ci]"

            # If a REPO_WRITE_TOKEN secret is provided, switch remote to use it (works for forks/PRs where GITHUB_TOKEN push is blocked)
            if [ -n "$REPO_TOKEN" ]; then
              echo "Using provided PAT to push changes"
              git remote set-url origin "https://x-access-token:$REPO_TOKEN@github.com/${{ github.repository }}.git"
            fi

            # Try to push back to the same branch that triggered the workflow.
            # Note: pushes from PRs originating from forks typically fail unless using a PAT.
            git push origin "HEAD:refs/heads/${{ github.ref_name }}" || echo "Push failed (likely a fork or missing permissions)."
          fi

      - name: Validate Maven project
        run: mvn validate

      - name: Compile project
        run: mvn compile

      - name: Run tests
        run: mvn test

      - name: Build plugin
        run: mvn clean package

      - name: List target directory (for debugging)
        run: ls -la target/

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: velocity-2fa-plugin-${{ github.run_number }}
          path: |
            target/*.jar
            !target/original-*.jar
          retention-days: 30
          if-no-files-found: error

      - name: Upload plugin to release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/*.jar
            !target/original-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
